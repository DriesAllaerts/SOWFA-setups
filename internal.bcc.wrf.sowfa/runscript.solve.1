#!/bin/bash
#SBATCH --job-name=internal.bcc.wrf             # Job name
#SBATCH --time=6-00:00:00                       # Walltime
#SBATCH --nodes=28                              # Number of nodes
#SBATCH --ntasks=1000                           # Number of processors per node
#SBATCH --account=mmc                           # Allocation
#SBATCH --mail-user dries.allaerts@nrel.gov     # E-mail adres
#SBATCH --mail-type BEGIN,END,FAIL              # Send e-mail when job begins, ends or fails

source $HOME/.bash_profile
OpenFOAM-6-dev

cd $SLURM_SUBMIT_DIR

cores=1000

initializer=setFieldsABL
solver=superDeliciousVanilla
which $solver

runNumber=1
startTime=43200

cp system/controlDict.$runNumber system/controlDict

echo "Starting OpenFOAM job at: " $(date)
echo "using " $cores " cores"
echo "with modules:"
module list

# Run the flow field initializer (parallel)
if [ $runNumber -eq 1 ] 
   then
   srun -n $cores --cpu_bind=cores $initializer -parallel > log.$runNumber.$initializer 2>&1
   rm -rf core*
fi

# Run the solver (parallel)
srun -n $cores --cpu_bind=cores $solver -parallel > log.$runNumber.$solver 2>&1

echo "Ending OpenFOAM job at: " $(date)
